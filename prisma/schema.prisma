// =============================================================================
// Prisma Schema for Feature Request Portal
// =============================================================================
// This schema defines the database structure for Vercel Postgres
// Run migrations with: npm run db:migrate
// Push changes without migration: npm run db:push
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// -----------------------------------------------------------------------------
// User Model
// -----------------------------------------------------------------------------
// Stores user information synced from NextAuth.js
// isAdmin is automatically set based on email domain (@meta.com, @fb.com)
// -----------------------------------------------------------------------------
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  isAdmin       Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth.js required relations
  accounts Account[]
  sessions Session[]

  // Application relations
  featureRequests FeatureRequest[]
  comments        Comment[]
  votes           Vote[]

  @@map("users")
}

// -----------------------------------------------------------------------------
// NextAuth.js Required Models
// -----------------------------------------------------------------------------
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// -----------------------------------------------------------------------------
// Feature Request Model
// -----------------------------------------------------------------------------
// Core model for feature requests submitted by users
// Supports voting, comments, merging duplicates, and admin management
// -----------------------------------------------------------------------------
model FeatureRequest {
  id          String              @id @default(cuid())
  title       String              @db.VarChar(100)
  description String              @db.Text
  summary     String?             @db.Text
  status      FeatureRequestStatus @default(under_review)

  // Author information (denormalized for performance)
  authorId    String
  authorName  String
  authorAvatar String?
  author      User                @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Tags stored as JSON array
  tags        String[]

  // Voting - count is denormalized for sorting performance
  upvotes     Int                 @default(0)
  votes       Vote[]

  // Comments - count is denormalized for display
  commentCount Int                @default(0)
  comments    Comment[]

  // Duplicate merging
  mergedFromIds String[]
  mergedIntoId  String?
  mergedInto    FeatureRequest?   @relation("MergedRequests", fields: [mergedIntoId], references: [id])
  mergedFrom    FeatureRequest[]  @relation("MergedRequests")

  // Admin features
  isPinned    Boolean             @default(false)
  adminNotes  String?             @db.Text

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([status])
  @@index([upvotes(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([isPinned(sort: Desc), upvotes(sort: Desc)])
  @@map("feature_requests")
}

// -----------------------------------------------------------------------------
// Feature Request Status Enum
// -----------------------------------------------------------------------------
enum FeatureRequestStatus {
  under_review
  planned
  in_progress
  implemented
  declined
}

// -----------------------------------------------------------------------------
// Vote Model
// -----------------------------------------------------------------------------
// Tracks individual votes to enforce one-vote-per-user-per-request
// -----------------------------------------------------------------------------
model Vote {
  id        String   @id @default(cuid())
  userId    String
  requestId String
  createdAt DateTime @default(now())

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  request FeatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@unique([userId, requestId])
  @@map("votes")
}

// -----------------------------------------------------------------------------
// Comment Model
// -----------------------------------------------------------------------------
// Supports two-level threading (parent comments and replies)
// parentId = null for top-level comments
// -----------------------------------------------------------------------------
model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text

  // Author information (denormalized for performance)
  authorId    String
  authorName  String
  authorAvatar String?
  author      User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Request relation
  requestId String
  request   FeatureRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // Two-level threading
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestId])
  @@index([parentId])
  @@map("comments")
}
